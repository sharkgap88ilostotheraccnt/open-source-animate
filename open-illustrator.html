<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Open Illustrator</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; background: #1c1c1c; color: #e0e0e0; font-family: "Segoe UI", sans-serif; overflow: hidden; font-size: 12px; }
    #app { display: grid; grid-template-columns: 80px 1fr 220px; grid-template-rows: 48px 1fr; height: 100%; }
    
    /* Topbar */
    #topbar {
      grid-column: 1 / 4;
      height: 48px;
      background: #2a2a2a;
      display: flex; align-items: center;
      padding: 0 15px; gap: 15px;
      border-bottom: 1px solid #444;
      font-size: 12px;
    }
    #topbar input[type=color], 
    #topbar input[type=number] {
      height: 24px;
      border: 1px solid #555; 
      background: #1e1e1e;
      color: white;
      border-radius: 3px;
      padding: 1px 4px;
    }
    #topbar button {
      background: #3a3a3a; 
      color: #fff; 
      border: none;
      border-radius: 4px;
      padding: 4px 8px;
      cursor: pointer;
      transition: background 0.2s;
      font-size: 12px;
    }
    #topbar button:hover {
      background: #f57c00;
    }

    /* Left Toolbar */
    #toolbar {
      grid-row: 2;
      background: #2b2b2b;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 12px 0;
      border-right: 1px solid #444;
    }
    #toolbar button {
      width: 48px; height: 48px;
      background: #3a3a3a; color: #fff;
      border: none; margin: 6px 0;
      cursor: pointer; font-size: 20px;
      border-radius: 6px;
      transition: background 0.2s, transform 0.2s;
    }
    #toolbar button:hover { background: #505050; transform: scale(1.05); }
    #toolbar button.active { background: #f57c00; box-shadow: 0 0 8px #f57c00; }

    /* Right Sidebar (Future Panels) */
    #sidebar {
      grid-row: 2;
      background: #2b2b2b;
      border-left: 1px solid #444;
      display: flex;
      flex-direction: column;
      padding: 10px;
      font-size: 11px;
    }
    .panel {
      background: #333;
      border: 1px solid #444;
      border-radius: 4px;
      margin-bottom: 10px;
      padding: 8px;
    }
    .panel h3 {
      font-size: 11px;
      text-transform: uppercase;
      margin-bottom: 6px;
      color: #aaa;
    }

    /* Canvas Container */
    #container {
      grid-row: 2;
      background: #2d2d2d;
      display: flex;
      align-items: center;
      justify-content: center;
    }
      canvas {
    background: #fff;
    width: 90%;
    height: 90%;
    border: 1px solid #ccc;
    cursor: crosshair;
  }

    /* Handles */
    .handle {
      width: 12px;
      height: 12px;
      background: #fdd835;
      border: 2px solid #000;
      position: absolute;
      transform: translate(-50%, -50%);
      cursor: pointer;
      border-radius: 50%;
      box-shadow: 0 0 4px rgba(0,0,0,0.6);
      pointer-events: auto;
      z-index: 10;
    }
  </style>
</head>
<body>
  <div id="app">
    <!-- Top Toolbar -->
    <div id="topbar">
      <label>Color: <input type="color" id="colorPicker" value="#000000"></label>
      <label>Stroke: <input type="number" id="strokeWidth" value="2" min="1" max="20"></label>
      <button id="undo">Undo</button>
      <button id="redo">Redo</button>
      <button id="exportPNG">PNG</button>
      <button id="saveJSON">JSON</button>
    </div>

    <!-- Left Toolbar -->
    <div id="toolbar">
      <button id="selectTool" title="Select">üñ±Ô∏è</button>
      <button id="rectTool" title="Rectangle">‚ñ≠</button>
      <button id="ellipseTool" title="Ellipse">‚ö™</button>
      <button id="lineTool" title="Line">Ôºè</button>
      <button id="penTool" title="Pen">‚úèÔ∏è</button>
    </div>

    <!-- Drawing Area -->
    <div id="container">
      <canvas id="canvas"></canvas>
    </div>

    <!-- Right Sidebar Panels -->
    <div id="sidebar">
      <div class="panel">
        <h3>Layers</h3>
        <p>(Coming soon)</p>
      </div>
      <div class="panel">
        <h3>Properties</h3>
        <p>(Future settings)</p>
      </div>
      <div class="panel">
        <h3>Color Palette</h3>
        <p>(Future swatches)</p>
      </div>
    </div>
  </div>
  <script>
  const canvas = document.getElementById("canvas"), ctx = canvas.getContext("2d");
  let w, h;
  let shapes = [], history = [], historyIndex = -1;
  let tool = "select", isDrawing = false, startX, startY, current = null, selected = null;
  let resizing = false, activeHandle = null, draggingPoint = null;
  const colorPicker = document.getElementById("colorPicker"), strokeWidthInput = document.getElementById("strokeWidth");

  function resize() {
    w = canvas.width = window.innerWidth - 60;
    h = canvas.height = window.innerHeight - 48;
    redraw();
  }
  window.addEventListener("resize", resize);

  function saveState() {
    history = history.slice(0, historyIndex + 1);
    history.push(JSON.stringify(shapes));
    historyIndex++;
  }

  function undo() {
    if (historyIndex > 0) {
      historyIndex--;
      shapes = JSON.parse(history[historyIndex]);
      selected = null;
      redraw();
    }
  }

  function redo() {
    if (historyIndex < history.length - 1) {
      historyIndex++;
      shapes = JSON.parse(history[historyIndex]);
      selected = null;
      redraw();
    }
  }

  function setTool(name) {
    tool = name;
    document.querySelectorAll("#toolbar button").forEach(b => b.classList.toggle("active", b.id === name + "Tool"));
    selected = null;
    redraw();
  }
  ["select", "rect", "ellipse", "line", "pen"].forEach(t => {
    document.getElementById(t + "Tool").onclick = () => setTool(t);
  });
  setTool("select");

  canvas.onmousedown = e => {
    const x = Math.max(0, Math.min(e.offsetX, w));
    const y = Math.max(0, Math.min(e.offsetY, h));
    if (tool === "select" && selected) {
      const handle = getHandleAt(x, y);
      if (handle) {
        resizing = true;
        activeHandle = handle;
        return;
      }
      if (selected.type === "pen") {
        draggingPoint = getPenPointAt(x, y);
        if (draggingPoint) return;
      }
    }
    if (tool === "select") {
      selected = shapes.find(s => hitTest(s, x, y)) || null;
      redraw();
    } else {
      isDrawing = true;
      startX = x;
      startY = y;
      current = { type: tool, x1: x, y1: y, x2: x, y2: y, points: [], color: colorPicker.value, width: parseInt(strokeWidthInput.value) };
      if (tool === "pen") current.points.push({ x, y });
      shapes.push(current);
      saveState();
    }
  };

  canvas.onmousemove = e => {
    const x = Math.max(0, Math.min(e.offsetX, w));
    const y = Math.max(0, Math.min(e.offsetY, h));
    if (resizing && selected) {
      resizeShape(selected, activeHandle, x, y);
      redraw();
      return;
    }
    if (draggingPoint && selected) {
      draggingPoint.x = x;
      draggingPoint.y = y;
      redraw();
      return;
    }
    if (!isDrawing || !current) return;
    current.x2 = x;
    current.y2 = y;
    if (tool === "pen") current.points.push({ x, y });
    redraw();
  };

  canvas.onmouseup = () => {
    if (isDrawing) saveState();
    isDrawing = false;
    current = null;
    resizing = false;
    activeHandle = null;
    draggingPoint = null;
  };

  function hitTest(s, x, y) {
    if (s.type === "rect") {
      const minX = Math.min(s.x1, s.x2), maxX = Math.max(s.x1, s.x2);
      const minY = Math.min(s.y1, s.y2), maxY = Math.max(s.y1, s.y2);
      return x >= minX && x <= maxX && y >= minY && y <= maxY;
    }
    if (s.type === "ellipse") {
      const rx = Math.abs((s.x2 - s.x1) / 2), ry = Math.abs((s.y2 - s.y1) / 2);
      const cx = Math.min(s.x1, s.x2) + rx, cy = Math.min(s.y1, s.y2) + ry;
      return ((x - cx) * (x - cx)) / (rx * rx) + ((y - cy) * (y - cy)) / (ry * ry) <= 1;
    }
    if (s.type === "line") {
      return distanceToLine({ x1: s.x1, y1: s.y1, x2: s.x2, y2: s.y2 }, { x, y }) < 5;
    }
    if (s.type === "pen") {
      return s.points.some(p => Math.hypot(p.x - x, p.y - y) < 5);
    }
    return false;
  }

  function getPenPointAt(x, y) {
    if (selected?.type === "pen") {
      return selected.points.find(p => Math.hypot(p.x - x, p.y - y) < 6);
    }
    return null;
  }

  function redraw() {
    ctx.clearRect(0, 0, w, h);
    shapes.forEach(s => {
      ctx.strokeStyle = s.color;
      ctx.lineWidth = s.width;
      ctx.beginPath();
      if (s.type === "rect") {
        const x = Math.min(s.x1, s.x2), y = Math.min(s.y1, s.y2);
        ctx.strokeRect(x, y, Math.abs(s.x2 - s.x1), Math.abs(s.y2 - s.y1));
      } else if (s.type === "ellipse") {
        const rx = Math.abs((s.x2 - s.x1) / 2), ry = Math.abs((s.y2 - s.y1) / 2);
        ctx.ellipse(
          Math.min(s.x1, s.x2) + rx,
          Math.min(s.y1, s.y2) + ry,
          rx, ry, 0, 0, 2 * Math.PI
        );
        ctx.stroke();
      } else if (s.type === "line") {
        ctx.moveTo(s.x1, s.y1);
        ctx.lineTo(s.x2, s.y2);
        ctx.stroke();
      } else if (s.type === "pen" && s.points.length) {
        ctx.beginPath();
        ctx.moveTo(s.points[0].x, s.points[0].y);
        s.points.slice(1).forEach(p => ctx.lineTo(p.x, p.y));
        ctx.stroke();
        if (selected === s) {
          ctx.fillStyle = "#ffd700";
          s.points.forEach(p => ctx.fillRect(p.x - 3, p.y - 3, 6, 6));
        }
      }
      if (selected === s) drawHandles(s);
    });
  }

  function drawHandles(s) {
    document.querySelectorAll(".handle").forEach(h => h.remove());
    const handles = getHandles(s);
    handles.forEach(h => {
      const div = document.createElement("div");
      div.className = "handle";
      div.style.left = h.x + "px";
      div.style.top = h.y + "px";
      document.getElementById("container").appendChild(div);
    });
  }

  function getHandles(s) {
    if (s.type === "rect" || s.type === "ellipse") {
      const minX = Math.min(s.x1, s.x2), maxX = Math.max(s.x1, s.x2);
      const minY = Math.min(s.y1, s.y2), maxY = Math.max(s.y1, s.y2);
      return [
        { name: "tl", x: minX, y: minY },
        { name: "tr", x: maxX, y: minY },
        { name: "bl", x: minX, y: maxY },
        { name: "br", x: maxX, y: maxY },
      ];
    }
    return [];
  }

  function getHandleAt(x, y) {
    if (!selected) return null;
    return getHandles(selected).find(h => Math.hypot(h.x - x, h.y - y) < 6);
  }

  function resizeShape(s, handle, x, y) {
    if (s.type === "rect" || s.type === "ellipse") {
      if (handle.name === "tl") { s.x1 = x; s.y1 = y; }
      else if (handle.name === "tr") { s.x2 = x; s.y1 = y; }
      else if (handle.name === "bl") { s.x1 = x; s.y2 = y; }
      else if (handle.name === "br") { s.x2 = x; s.y2 = y; }
    }
  }

  function distanceToLine(l, p) {
    const { x1, y1, x2, y2 } = l;
    const A = p.x - x1, B = p.y - y1, C = x2 - x1, D = y2 - y1;
    const dot = A * C + B * D, len2 = C * C + D * D;
    const param = len2 ? dot / len2 : -1;
    let xx, yy;
    if (param < 0) { xx = x1; yy = y1; }
    else if (param > 1) { xx = x2; yy = y2; }
    else { xx = x1 + param * C; yy = y1 + param * D; }
    return Math.hypot(p.x - xx, p.y - yy);
  }

  document.getElementById("undo").onclick = undo;
  document.getElementById("redo").onclick = redo;
  document.getElementById("exportPNG").onclick = () => {
    const link = document.createElement("a");
    link.download = "drawing.png";
    link.href = canvas.toDataURL();
    link.click();
  };
  document.getElementById("saveJSON").onclick = () => {
    const blob = new Blob([JSON.stringify(shapes)], { type: "application/json" });
    const link = document.createElement("a");
    link.download = "drawing.json";
    link.href = URL.createObjectURL(blob);
    link.click();
  };

  window.addEventListener("keydown", e => {
    if ((e.key === "Delete" || e.key === "Backspace") && selected) {
      shapes = shapes.filter(s => s !== selected);
      selected = null;
      saveState();
      redraw();
    } else if (e.ctrlKey && e.key === "z") {
      undo();
    } else if (e.ctrlKey && e.key === "y") {
      redo();
    }
  });

  // Initialize canvas after all variables are defined
  resize();
</script>
</body>
</html>
