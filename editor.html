<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Mini Animate with Transform Tools & Symbol Library</title>
<link rel="icon" href="data:;base64,iVBORw0KGgo=">
<style>
  body {
    background: #1c2526;
    color: #d9d9d9;
    font-family: 'Helvetica Neue', Arial, sans-serif;
    margin: 0;
    overflow: hidden;
  }
  h2 {
    text-align: center;
    margin: 10px 0;
    font-size: 18px;
    color: #e6e6e6;
    text-transform: uppercase;
    letter-spacing: 1px;
  }
  button {
    padding: 8px;
    cursor: pointer;
    background: #2e2e2e;
    color: #d9d9d9;
    border: 1px solid #444;
    border-radius: 4px;
    font-size: 12px;
    transition: background 0.2s, color 0.2s;
  }
  button:hover {
    background: #4a4a4a;
    color: #fff;
  }
  button.active {
    background: #0078d7;
    color: #fff;
  }
  #topToolbar {
    text-align: center;
    margin: 10px 0;
    background: #2e2e2e;
    padding: 8px;
    border-bottom: 1px solid #444;
  }
  #mainContainer {
    display: flex;
    gap: 8px;
    width: 1000px;
    margin: 10px auto;
    background: #252526;
    padding: 10px;
    border-radius: 6px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
  }
  #canvasAndTimeline {
    flex-grow: 1;
    position: relative;
  }
  canvas {
    background: #333;
    display: block;
    user-select: none;
    border: 1px solid #444;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
  }
  #timeline {
    width: 100%;
    height: 80px;
    background: #2e2e2e;
    position: relative;
    user-select: none;
    border-top: 1px solid #444;
    margin-top: 8px;
    border-radius: 4px;
  }
  .frame {
    width: 12px;
    height: 100%;
    border-right: 1px solid #555;
    float: left;
    position: relative;
  }
  .frame:nth-child(5n)::before {
    content: attr(data-frame);
    position: absolute;
    top: 5px;
    font-size: 10px;
    color: #999;
    text-align: center;
    width: 12px;
  }
  .keyframe {
    width: 8px;
    height: 8px;
    background: #ffd700;
    position: absolute;
    top: 30px;
    cursor: pointer;
    border-radius: 50%;
    border: 1px solid #000;
    transition: transform 0.2s;
  }
  .keyframe:hover {
    transform: scale(1.3);
  }
  #playhead {
    width: 2px;
    height: 100%;
    background: #ff4d4d;
    position: absolute;
    top: 0;
    z-index: 10;
  }
  #symbolLibrary {
    width: 180px;
    background: #2e2e2e;
    color: #d9d9d9;
    padding: 10px;
    display: flex;
    flex-direction: column;
    gap: 8px;
    border-radius: 6px;
    user-select: none;
    max-height: 480px;
    overflow-y: auto;
    border: 1px solid #444;
  }
  #symbolLibrary strong {
    font-size: 12px;
    text-transform: uppercase;
    color: #e6e6e6;
    margin-bottom: 5px;
  }
  #symbolLibrary img {
    width: 60px;
    height: 60px;
    object-fit: contain;
    cursor: pointer;
    border: 2px solid transparent;
    border-radius: 4px;
    background: #333;
    transition: border-color 0.2s;
  }
  #symbolLibrary img:hover {
    border-color: #ffd700;
  }
  #transformToolbar {
    width: 60px;
    background: #2e2e2e;
    color: #d9d9d9;
    padding: 10px;
    display: flex;
    flex-direction: column;
    gap: 8px;
    border-radius: 6px;
    user-select: none;
    border: 1px solid #444;
  }
  #transformToolbar strong {
    font-size: 12px;
    text-transform: uppercase;
    color: #e6e6e6;
  }
  #transformToolbar button {
    font-size: 14px;
    padding: 8px;
    text-align: center;
  }
</style>
</head>
<body>

<div id="topToolbar">
  <button id="addObj">Add Rectangle</button>
  <button id="addKey">Add Keyframe</button>
  <button id="play">Play</button>
  <button id="createSymbol">New Symbol</button>
  <button id="deleteObj">Delete</button>
  <button id="saveProject">üíæ Save Project as JSON</button>
  <button id="exportPNG">üñºÔ∏è Export Current Frame </button>
  <button id="exportFrames">üìÅ Export All Frames (ZIP)</button>
  <button id="exportMP4">üé¨ Export MP4</button>


</div>

<div id="mainContainer">
  <div id="transformToolbar">
    <strong>Tools</strong>
    <button id="moveTool" title="Move">‚Üî</button>
    <button id="scaleTool" title="Scale">‚¨õ</button>
    <button id="rotateTool" title="Rotate">‚Üª</button>
    <button id="flipH" title="Flip Horizontal">‚áÜ</button>
    <button id="flipV" title="Flip Vertical">‚áÖ</button>
  </div>

  <div id="canvasAndTimeline">
    <canvas id="canvas" width="600" height="400"></canvas>
    <div id="timeline"></div>
  </div>

  <div id="symbolLibrary">
    <strong>Library</strong>
  </div>
</div>
  
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.6/dist/ffmpeg.min.js"></script>

  
<script>
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const timeline = document.getElementById("timeline");
const symbolLibraryDiv = document.getElementById("symbolLibrary");

let objects = [];
let selected = null;
let dragging = false;
let offsetX, offsetY;
let startScale;
let dragStartAngle;
let startRotation;

let frames = 60;
let currentFrame = 0;
let keyframes = {};
let isPlaying = false;
let symbolLibrary = [];

let currentTool = "move";

// Save project as JSON
document.getElementById("saveProject").onclick = () => {
  const data = JSON.stringify({ objects, keyframes, symbols: symbolLibrary });
  const blob = new Blob([data], { type: "application/json" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "project.json";
  a.click();
};

// Export PNG of current frame
document.getElementById("exportPNG").onclick = () => {
  const link = document.createElement("a");
  link.download = "frame.png";
  link.href = canvas.toDataURL("image/png");
  link.click();
};

// Load project if coming from main menu
const loaded = localStorage.getItem('loadedProject');
if (loaded) {
  const { objects: objs, keyframes: keys, symbols } = JSON.parse(loaded);
  objects = objs;
  keyframes = keys;
  symbolLibrary = symbols;
  updateSymbolLibrary();
  localStorage.removeItem('loadedProject');
  draw();
}

document.getElementById("exportFrames").onclick = async () => {
  const zip = new JSZip();
  
  for (let frame = 0; frame < frames; frame++) {
    updateObjectsForFrame(frame);
    draw();
    const dataURL = canvas.toDataURL("image/png");
    zip.file(`frame_${String(frame).padStart(3, "0")}.png`, dataURL.split(",")[1], {base64: true});
    await new Promise(r => setTimeout(r, 10)); // Avoid blocking UI
  }
  
  zip.generateAsync({ type: "blob" }).then(content => {
    saveAs(content, "animation_frames.zip");
  });
};

const { createFFmpeg, fetchFile } = FFmpeg;
const ffmpeg = createFFmpeg({ log: true });

document.getElementById("exportMP4").onclick = async () => {
  if (!ffmpeg.isLoaded()) await ffmpeg.load();

  // Save each frame in memory
  for (let frame = 0; frame < frames; frame++) {
    updateObjectsForFrame(frame);
    draw();
    const dataURL = canvas.toDataURL("image/png");
    const blob = await (await fetch(dataURL)).blob();
    ffmpeg.FS('writeFile', `frame_${String(frame).padStart(3,"0")}.png`, new Uint8Array(await blob.arrayBuffer()));
  }

  // Encode to MP4
  await ffmpeg.run(
    '-framerate', '30',
    '-i', 'frame_%03d.png',
    '-c:v', 'libx264',
    '-pix_fmt', 'yuv420p',
    'output.mp4'
  );

  const data = ffmpeg.FS('readFile', 'output.mp4');
  const videoBlob = new Blob([data.buffer], { type: 'video/mp4' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(videoBlob);
  a.download = 'animation.mp4';
  a.click();

  // Cleanup
  ffmpeg.FS('unlink', 'output.mp4');
};

  
// Playhead
const playhead = document.createElement("div");
playhead.id = "playhead";

// Initialize timeline
function initTimeline() {
  timeline.innerHTML = "";
  for (let i = 0; i < frames; i++) {
    const div = document.createElement("div");
    div.className = "frame";
    div.dataset.frame = i;
    timeline.appendChild(div);
  }
  timeline.appendChild(playhead);
}
initTimeline();

function updatePlayhead() {
  const timelineWidth = timeline.clientWidth;
  const pos = (currentFrame / (frames - 1)) * timelineWidth;
  playhead.style.left = pos + "px";
}

// Timeline interaction
let scrubDragging = false;

timeline.addEventListener("mousedown", (e) => {
  scrubDragging = true;
  movePlayhead(e);
});

timeline.addEventListener("mousemove", (e) => {
  if (scrubDragging) movePlayhead(e);
});

window.addEventListener("mouseup", () => scrubDragging = false);

function movePlayhead(e) {
  const rect = timeline.getBoundingClientRect();
  const x = Math.max(0, Math.min(e.clientX - rect.left, rect.width));
  const frame = Math.floor((x / rect.width) * frames);
  currentFrame = frame;
  updatePlayhead();
  updateObjectsForFrame(frame);
  draw();
}

// Toolbar buttons
document.getElementById("addObj").onclick = () => {
  const obj = { 
    id: Date.now(), x: 100, y: 100, w: 80, h: 80, 
    color: `hsl(${Math.random()*360},70%,50%)`,
    rotation: 0, scaleX: 1, scaleY: 1, image: null,
  };
  objects.push(obj);
  keyframes[obj.id] = [];
  selected = obj;
  draw();
};

document.getElementById("addKey").onclick = () => {
  if (selected) {
    keyframes[selected.id].push({ 
      frame: currentFrame, x: selected.x, y: selected.y, 
      w: selected.w, h: selected.h, 
      rotation: selected.rotation || 0, 
      scaleX: selected.scaleX || 1, 
      scaleY: selected.scaleY || 1
    });
    renderKeyframes();
  }
};

document.getElementById("play").onclick = () => {
  if (isPlaying) return;
  isPlaying = true;
  let frame = currentFrame;
  function animate() {
    if (frame >= frames) { isPlaying = false; currentFrame = 0; updatePlayhead(); draw(); return; }
    currentFrame = frame;
    updateObjectsForFrame(frame);
    draw();
    updatePlayhead();
    frame++;
    requestAnimationFrame(animate);
  }
  animate();
};

document.getElementById("deleteObj").onclick = () => {
  if (!selected) return;
  objects = objects.filter(o => o !== selected);
  delete keyframes[selected.id];
  selected = null;
  draw();
  renderKeyframes();
};

document.getElementById("createSymbol").onclick = () => {
  window.open("symbol-editor.html", "SymbolEditor", "width=500,height=500");
};

// Transform tools
document.getElementById("moveTool").onclick = () => { currentTool = "move"; updateToolUI(); };
document.getElementById("scaleTool").onclick = () => { currentTool = "scale"; updateToolUI(); };
document.getElementById("rotateTool").onclick = () => { currentTool = "rotate"; updateToolUI(); };

document.getElementById("flipH").onclick = () => {
  if (!selected) return;
  selected.scaleX = (selected.scaleX || 1) * -1;
  draw();
};

document.getElementById("flipV").onclick = () => {
  if (!selected) return;
  selected.scaleY = (selected.scaleY || 1) * -1;
  draw();
};

function updateToolUI() {
  ["moveTool", "scaleTool", "rotateTool"].forEach(id => {
    const btn = document.getElementById(id);
    btn.classList.toggle("active", currentTool === id.replace("Tool", ""));
  });
}
updateToolUI();

// Canvas interaction
function pointInObject(x, y, o) {
  return x > o.x && x < o.x + o.w && y > o.y && y < o.y + o.h;
}

canvas.onmousedown = e => {
  const mx = e.offsetX, my = e.offsetY;
  if (currentTool === "move") {
    selected = objects.find(o => pointInObject(mx, my, o));
    if (selected) {
      dragging = true;
      offsetX = mx - selected.x;
      offsetY = my - selected.y;
    }
  } else if (currentTool === "scale") {
    selected = objects.find(o => pointInObject(mx, my, o));
    if (selected) {
      dragging = true;
      offsetX = mx;
      offsetY = my;
      startScale = { w: selected.w, h: selected.h };
    }
  } else if (currentTool === "rotate") {
    selected = objects.find(o => pointInObject(mx, my, o));
    if (selected) {
      dragging = true;
      const cx = selected.x + selected.w/2;
      const cy = selected.y + selected.h/2;
      dragStartAngle = Math.atan2(my - cy, mx - cx);
      startRotation = selected.rotation || 0;
    }
  }
  draw();
};

canvas.onmousemove = e => {
  if (!dragging || !selected) return;
  const mx = e.offsetX, my = e.offsetY;

  if (currentTool === "move") {
    selected.x = mx - offsetX;
    selected.y = my - offsetY;
  } else if (currentTool === "scale") {
    selected.w = Math.max(10, startScale.w + (mx - offsetX));
    selected.h = Math.max(10, startScale.h + (my - offsetY));
  } else if (currentTool === "rotate") {
    const cx = selected.x + selected.w/2;
    const cy = selected.y + selected.h/2;
    const angle = Math.atan2(my - cy, mx - cx);
    const diff = angle - dragStartAngle;
    selected.rotation = startRotation + diff * (180/Math.PI);
  }
  draw();
};

canvas.onmouseup = () => dragging = false;

// Draw function
function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  objects.forEach(o => {
    ctx.save();
    const cx = o.x + o.w/2;
    const cy = o.y + o.h/2;
    ctx.translate(cx, cy);
    ctx.rotate((o.rotation || 0) * Math.PI / 180);
    ctx.scale(o.scaleX || 1, o.scaleY || 1);
   if (o.image) {
  ctx.drawImage(o.image, -o.w/2, -o.h/2, o.w, o.h);
} else {
  ctx.fillStyle = o.color;
  ctx.fillRect(-o.w/2, -o.h/2, o.w, o.h);
}

    if (o === selected) {
      ctx.strokeStyle = "#ffd700";
      ctx.lineWidth = 2;
      ctx.strokeRect(-o.w/2, -o.h/2, o.w, o.h);
    }
    ctx.restore();
  });
}

// Timeline keyframes
function renderKeyframes() {
  document.querySelectorAll(".keyframe").forEach(el => el.remove());
  for (const objId in keyframes) {
    keyframes[objId].forEach(kf => {
      const dot = document.createElement("div");
      dot.className = "keyframe";
      dot.style.left = (kf.frame * 12 + 2) + "px";
      dot.onclick = () => {
        currentFrame = kf.frame;
        const obj = objects.find(o => o.id == objId);
        if (obj) {
          obj.x = kf.x;
          obj.y = kf.y;
          obj.w = kf.w;
          obj.h = kf.h;
          obj.rotation = kf.rotation;
          obj.scaleX = kf.scaleX;
          obj.scaleY = kf.scaleY;
          selected = obj;
          draw();
          updatePlayhead();
        }
      };
      timeline.appendChild(dot);
    });
  }
}

// Frame interpolation
function updateObjectsForFrame(frame) {
  objects.forEach(obj => {
    const keys = keyframes[obj.id];
    if (!keys || keys.length < 2) return;
    let prev = keys[0], next = keys[keys.length - 1];
    for (let i = 0; i < keys.length - 1; i++) {
      if (frame >= keys[i].frame && frame <= keys[i+1].frame) {
        prev = keys[i];
        next = keys[i+1];
        break;
      }
    }
    const t = (frame - prev.frame) / (next.frame - prev.frame);
    obj.x = prev.x + (next.x - prev.x) * t;
    obj.y = prev.y + (next.y - prev.y) * t;
    obj.w = prev.w + (next.w - prev.w) * t;
    obj.h = prev.h + (next.h - prev.h) * t;
    obj.rotation = prev.rotation + (next.rotation - prev.rotation) * t;
    obj.scaleX = prev.scaleX + (next.scaleX - prev.scaleX) * t;
    obj.scaleY = prev.scaleY + (next.scaleY - prev.scaleY) * t;
  });
}

// Symbol library
window.receiveSymbol = function(dataURL) {
  symbolLibrary.push(dataURL);
  updateSymbolLibrary();

  const img = new Image();
  img.src = dataURL;
  img.onload = () => {
    const obj = { 
      id: Date.now(), x: 100, y: 100, w: img.width / 2, h: img.height / 2,
      rotation: 0, scaleX: 1, scaleY: 1, image: img, color: null,
    };
    objects.push(obj);
    keyframes[obj.id] = [];
    selected = obj;
    draw();
  };
};

function updateSymbolLibrary() {
  symbolLibraryDiv.querySelectorAll("img").forEach(img => img.remove());
  symbolLibrary.forEach((dataURL, index) => {
    const img = new Image();
    img.src = dataURL;
    img.title = `Symbol ${index+1}`;
    img.onclick = () => {
      const symbolImg = new Image();
      symbolImg.src = dataURL;
      symbolImg.onload = () => {
        const obj = { 
          id: Date.now(), x: 100, y: 100, w: symbolImg.width/2, h: symbolImg.height/2,
          rotation: 0, scaleX: 1, scaleY: 1, image: symbolImg, color: null
        };
        objects.push(obj);
        keyframes[obj.id] = [];
        selected = obj;
        draw();
      };
    };
    symbolLibraryDiv.appendChild(img);
  });
}

draw();
</script>
</body>
</html>
