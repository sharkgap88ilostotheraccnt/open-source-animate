<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Symbol Editor</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<style>
  body { background: #1c2526; color: #fff; font-family: sans-serif; text-align: center; margin: 0; }
  h2 { margin: 10px 0; }
  canvas { background: #fff; border: 1px solid #444; cursor: crosshair; display: block; margin: 10px auto; }
  #toolbar { background: #2e2e2e; padding: 10px; }
  button { margin: 4px; padding: 6px 10px; cursor: pointer; background: #444; color: #fff; border: none; }
  button:hover { background: #666; }
  #colorPicker, #brushSize { margin-left: 10px; }
</style>
</head>
<body>
  <h2>Symbol Editor</h2>
  <div id="toolbar">
    <button id="drawBtn">✏️ Draw</button>
    <button id="eraseBtn">🧽 Erase</button>
    <input type="color" id="colorPicker" value="#000000">
    Brush size: <input type="range" id="brushSize" min="1" max="20" value="5">
    <button id="clearBtn">🗑️ Clear</button>
    <button id="saveSymbol">💾 Save Symbol</button>
    <button id="exportZip">📦 Export ZIP</button>
  </div>
  <canvas id="editorCanvas" width="400" height="400"></canvas>

<script>
const canvas = document.getElementById("editorCanvas");
const ctx = canvas.getContext("2d");
let drawing = false;
let erasing = false;
let brushColor = document.getElementById("colorPicker").value;
let brushSize = document.getElementById("brushSize").value;

document.getElementById("drawBtn").onclick = () => { erasing = false; };
document.getElementById("eraseBtn").onclick = () => { erasing = true; };
document.getElementById("colorPicker").oninput = e => { brushColor = e.target.value; };
document.getElementById("brushSize").oninput = e => { brushSize = e.target.value; };

canvas.addEventListener("mousedown", () => drawing = true);
canvas.addEventListener("mouseup", () => drawing = false);
canvas.addEventListener("mouseout", () => drawing = false);
canvas.addEventListener("mousemove", draw);

function draw(e) {
  if (!drawing) return;
  ctx.beginPath();
  ctx.arc(e.offsetX, e.offsetY, brushSize / 2, 0, Math.PI * 2);
  ctx.fillStyle = erasing ? "#fff" : brushColor;
  ctx.fill();
}

document.getElementById("clearBtn").onclick = () => {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.fillStyle = "#fff";
  ctx.fillRect(0, 0, canvas.width, canvas.height);
};

// Init background white
ctx.fillStyle = "#fff";
ctx.fillRect(0, 0, canvas.width, canvas.height);

document.getElementById("saveSymbol").onclick = () => {
  const dataURL = canvas.toDataURL("image/png");
  if (window.opener && window.opener.receiveSymbol) {
    window.opener.receiveSymbol(dataURL);
  }
  window.close();
};

document.getElementById("exportZip").onclick = () => {
  const zip = new JSZip();
  // For now just one frame = symbol, but can be expanded
  zip.file("frame_1.png", dataURLtoBlob(canvas.toDataURL("image/png")), { binary: true });
  zip.generateAsync({ type: "blob" }).then(content => {
    saveAs(content, "symbol_frames.zip");
  });
};

function dataURLtoBlob(dataurl) {
  const arr = dataurl.split(',');
  const mime = arr[0].match(/:(.*?);/)[1];
  const bstr = atob(arr[1]);
  let n = bstr.length;
  const u8arr = new Uint8Array(n);
  while (n--) u8arr[n] = bstr.charCodeAt(n);
  return new Blob([u8arr], { type: mime });
}
</script>
</body>
</html>
